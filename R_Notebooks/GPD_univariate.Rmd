---
title: "GPD Univariate/Bivariate - EDA"
author: "Mongi Nouira"
output: github_document
---

```{r, include=FALSE}
library(htmltools)

knitr::knit_hooks$set(imgcenter = function(before, options, envir){
  if (before) {
    HTML("<p align='center'>")
  } else {
    HTML("</p>")
  }
})

knitr::opts_chunk$set(
  echo=FALSE, cache=TRUE, imgcenter=TRUE, 
  fig.align="center", dpi=150, fig.width=7
)

library("ismev")
library("evd")

# Color Map
c1 = "#636EFA"
c2 = "#EF553B"
```

Using the univariate Generalized Pareto Distribution for EDA (Threshold selection, Frechet Scale, ...). The time series correspond to log daily losses. We focus on the Technology sector.

```{r}
df = read.csv("~/Documents/GitHub/PDM_2022/data/data1.csv")

ll = -100*sapply(df[seq(2,12)], function(x) log(x[-1])-log(x[-length(df$Date)]))
#ll = apply(ll, c(1,2), function(x) max(x,0))
ll = data.frame(ll)
ll$Date = df$Date[-1]
```

## Technology Sector

First, we look at the mean residual life plot with 95% confidence intervals. It is initially linear the shows curvature between -1 and 5 then is reasonably linear relatively to confidence intervals. This may suggest that a loss of 5% is a good threshold. However, there are only 24 exceedances in the data of 5045 observations. The threshold of 2% seems more appropriate with 367 exceedances.

```{r}
mrl.plot(ll$S.P.Technology, conf=0.95)
title(main="Mean Residual Life Plot")
```

Second, we look at the stability of GPD parameters when changing the threshold. The selected threshold of 2 seems reasonable.

```{r}
gpd.fitrange(ll$S.P.Technology, 0, 7)
title(main="Parameters vs Threshold")
```

Finally, we fit the GPD with threshold u=2. It is summarised as following :

```{r echo=FALSE}
fit <- ismev::gpd.fit(ll$S.P.Technology, threshold=2, npy=251)
```

```{r, fig.asp=1}
par(mfrow=c(1,1), oma=c(0,0,4,0))
gpd.diag(fit)
par(oma=c(0,0,0,0))
title(main="Fitted GPD With Threshold u=2 Diagnostic")
```

## Bivariate EDA : Technology/Energy

In this section, we are interested in the asymptotic dependence between the technology and energy sectors.

First, we look at the scatter plots of the two sectors and the corresponding 95% marginal quantiles. We can also do the same plot after transformation to the Frechet scale and using the logarithmic scale for the axis.

```{r}
u = 2
frechet_scale = function(x,shape,scale,exec) -(log(1-exec*(1+shape*(x-u)/scale)^(-1/shape)))

cond_nan = ll$S.P.Technology>2 & ll$S.P.Energy>2

fit1 <- ismev::gpd.fit(ll$S.P.Technology, threshold=u, npy=251, show=FALSE)
x1 = frechet_scale(ll$S.P.Technology[cond_nan],fit1$mle[2],fit1$mle[1],fit1$rate)

fit2 <- ismev::gpd.fit(ll$S.P.Energy, threshold=u, npy=251, show=FALSE)
x2 = frechet_scale(ll$S.P.Energy[cond_nan],fit2$mle[2],fit2$mle[1],fit2$rate)

par(mfrow=c(1,2), pty="s")
plot(x=ll$S.P.Technology, y=ll$S.P.Energy, xlab="Technology", ylab="Energy")
abline(v=quantile(ll$S.P.Technology, 0.95), col=c2)
abline(h=quantile(ll$S.P.Energy, 0.95), col=c2)

plot(x=x1, y=x2, xlab="Technology", ylab="Energy", log="xy")
#abline(v=quantile(x1, 0.95, na.rm=TRUE), col=c2, untf=TRUE)
#abline(h=quantile(x2, 0.95, na.rm=TRUE), col=c2, untf=TRUE)

title(main="Technology/Energy Pair - 95% Marginal Quantiles", outer=TRUE, line=-2)
```

We can compute the two marginals empirical cumulative distribution function then transform both variables to the Frechet scale using the formula $\hat{X}=-\frac{1}{log(F_X(X))}$.

```{r}
fn1 = ecdf(ll$S.P.Technology)
x1 = fn1(ll$S.P.Technology)
q1 = quantile(ll$S.P.Technology, 0.95)

fn2 = ecdf(ll$S.P.Energy)
x2 = fn2(ll$S.P.Technology)
q2 = quantile(ll$S.P.Energy, 0.95)

plot(x=x1, y=x2, xlab="Technology", ylab="Energy", log="xy")
abline(v=fn1(q1), col=c2, untf=TRUE)
abline(h=fn2(q2), col=c2, untf=TRUE)
title(main="Technology/Energy Pair - 95% Marginal Quantiles")
```

Second, we look at the chi plots with 95% confidence intervals. The interpretation is not simple because the confidence intervals are large i.e. a high variance of the estimators but it seems that $\bar\chi(q) \rightarrow 1$ when $q \rightarrow 1$ with a value around 0.65. This supports the asymptotic dependence between the two sectors.

```{r}
par(pty="s")
evd::chiplot(
  ll[,c(6,7)], which=1, 
  main1="Technology/Energy", 
  xlab="Quantile", ylab1="Chi / Chi Bar",
  col=c1, cicol=c1
)
par(new=TRUE)
evd::chiplot(
  ll[,c(6,7)], which=2, 
  main2="", xlab="", ylab2="",
  col=c2, cicol=c2
)

grid(nx=10,ny=20)
legend("bottomright", c("Chi","Chi Bar"), col=c(c1,c2), cex=0.8, fill=c(c1,c2))
```

Finally, we fit the logistic bivariate extreme value distribution for the exceedances over the threshold u=2.

```{r, echo=FALSE}
sup_u = ll$S.P.Technology>2 & ll$S.P.Energy>2
fitbv <- fbvevd(ll[sup_u,c(6,7)], model="log", std.err=FALSE)
fitbv
```


```{r, fig.asp=1}
par(mfrow=c(2,2), pty="s")
plot(fitbv, mar=1, which=c(3,4))
plot(fitbv, mar=2, which=c(3,4))
```

```{r, fig.asp=1}
par(mfrow=c(2,2), pty="s")
plot(fitbv, which=c(3,4))
plot(fitbv, which=c(5,6))
```

We can also do the same thing using another function "evd::fbvpot" and specifying the threshold u=2. Maximum-likelihood Fitting of Bivariate Extreme Value Distributions to Threshold Exceedances.

```{r}
u = apply(ll[,c(6,7)],2,quantile,0.95)
fitbv <- fbvpot(ll[,c(6,7)], threshold=c(2,2), model="log", likelihood="poisson", std.err=FALSE)

par(mfrow=c(1,2), pty="s", oma=c(0,0,4,0))
plot(fitbv, which=c(1,3))
par(oma=c(0,0,0,0))
title(main="MLE Logistic BEVD - Threshold = 2", outer=TRUE, line=-3)
```

